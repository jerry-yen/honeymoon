<?php
class Checkin_Controller extends AdminController {		// 用戶	protected $member;	// 打卡時間	protected $check_date_time = "";	// 顯示目前打卡是屬於上班或下班，呈現在畫面上	protected $work_status = "上班";	// 是否加班	protected $is_overtime = false;	// 是否加班	protected $overtimes = array();	// 最近一筆打卡記錄的 ID	protected $last_item_id = "";	// 是否採用預設上下班資訊	protected $work_setting = array();		public function main() {						// 取得今日指定用戶的所有打卡記錄		@session_start();				$this -> member = $this -> get_single_item("member", $_SESSION[$_SERVER["HTTP_HOST"] . "-login-session"]);		$items = $this -> get_items("checkin",array("DATE_FORMAT(check_date_time,'%Y-%m-%d')=?","title=?"),array(date("Y-m-d"),$this -> member -> id),array("check_date_time DESC"));				$this -> module_loader -> load("utility");		$this -> work_setting = $this -> module_utility -> get_member_work_setting($_SESSION[$_SERVER["HTTP_HOST"] . "-login-session"]);				@session_write_close();				if($this -> work_setting["is_working"] != "Y"){			$this -> module_alert -> set_message("本日放假，不需打卡！");			$this -> module_go -> back();		}								// 本次打卡時間		$this -> check_date_time = date("Y-m-d H:i:s");				// 本日第一次打卡		if(count($items) == 0){			$item = $this -> get_single_item("checkin","");			$item -> title -> set_value("");			$item -> check_date_time -> set_value($this -> check_date_time);			$item -> check_ip -> set_value($_SERVER["REMOTE_ADDR"]);			$item -> status -> set_value(1); // 上班						$this -> work_status = "上班";						$module = $this -> module_dao -> get_object("module",$item -> moduleId);			$this -> last_item_id = $module -> add_item($item);		}		else{						$prev_item = $items[0];			$status = $prev_item -> status -> get_value();						$item = $this -> get_single_item("checkin","");			$item -> title -> set_value("");			$item -> check_date_time -> set_value($this -> check_date_time);			$item -> check_ip -> set_value($_SERVER["REMOTE_ADDR"]);			$item -> status -> set_value(($status == "1")?"2":"1"); // 下班			$this -> work_status = ($status == "1")?"下班":"上班";			$module = $this -> module_dao -> get_object("module",$item -> moduleId);			$this -> last_item_id = $module -> add_item($item);		}				$this -> overtimes = $this -> module_utility -> get_overtime(strtotime($this -> check_date_time), $items, $this -> work_setting);		$this -> is_overtime = (count($this -> overtimes) > 0);			}
}?>