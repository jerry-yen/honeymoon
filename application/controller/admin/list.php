<?php
class List_Controller extends AdminController {	/**	 * 模組	 */	public $module = array();		/**	 * 導覽路徑	 */	protected $nav_class = array();		/**	 * 父分類	 */	protected $parent_class = array();		/**	 * 分類	 */	protected $item_classes = array();		/**	 * 清單欄位	 */	protected $list_fields = array();		/**	 * 搜尋欄位	 */	protected $search_fields = array();	public function main() {				// 取得模組代碼 並 取得模組元件		$module_code = $this -> module_io -> mod;		$this -> module = $this -> module_dao -> get_object("module");		$this -> module -> get_module($module_code);				// 如為設定頁面		if ($this -> module -> moduleType == "Note") {			$this -> module_go -> page("note.php?mod=" . $module_code);		}				// 如為設定頁面
		if ($this -> module -> single == "Y") {			$this -> module_go -> page("fix_item.php?mod=" . $module_code);		}				// 如此模組無分類，項目清單頁		if ($this -> module -> level == "0"){ // || in_array($this -> module -> moduleType,array("Form","User"))){			$this -> module_go -> page("list_item.php?mod=" . $module_code);		}				// 載入分類清單		$this -> load_item_classes();				// 載入清單欄位		$this -> load_fields();				// 載入導覽		$this -> load_nav();				$this -> load_search_component();	}		/**	 * 載入導覽	 */ 	private function load_nav(){		if($this -> module_io -> id != ""){			$parent = $this -> module -> get_single_class(array("id=?"),array($this -> module_io -> id));			while($parent -> is_exists()){				$this -> nav_class[] = $parent;				$parent = $parent -> get_parent();			}						$this -> nav_class = array_reverse($this -> nav_class);		}	}		/**	 * 載入搜尋元件	 */	private function load_search_component(){				if(!is_array($this -> module -> fieldSearch)){			$this -> module -> fieldSearch = json_decode($this -> module -> fieldSearch);			$this -> module -> fieldSearch = is_null($this -> module -> fieldSearch) ? array() : $this -> module -> fieldSearch; 		}				require_once ($this -> config_full_application_path . "/custom/components/Component.php");				foreach($this -> module -> fieldSearch as $field){			$fieldMetadata["name"] = $field -> fieldSearch_field_name;			$fieldMetadata["variable"] = $field -> fieldSearch_field_variable;			$fieldMetadata["type"] = $field -> fieldSearch_field_type;			$fieldMetadata["element"] = $field -> fieldSearch_field_element;			$fieldMetadata["default"] = "";			$fieldMetadata["tip"] = "";						require_once ($this -> config_full_application_path . "/custom/components/" . $fieldMetadata["type"] . "_Component.php");			$component_name = $fieldMetadata["type"] . "_Component";						$this -> search_fields[$fieldMetadata["variable"]] = new $component_name($this -> module_io -> {$fieldMetadata["variable"]}, $fieldMetadata, $this -> module);		}	}	/**	 * 載入分類清單	 */ 	private function load_item_classes() {				/*		 * 如果網址沒有ID參數，代表根目錄		 **/		if($this -> module_io -> id == ""){						$this -> is_special_level = ($this -> module -> class_field_use_level == 1);						$this -> module_pagination -> set_count_per_page($this -> module -> class_count_per_page);			$this -> module_pagination -> unlock();			$this -> item_classes = $this -> module -> get_classes(array(), array(), array("sortTime ASC", "sequence ASC", "createTime DESC"), $this -> is_special_level);			$this -> module_pagination -> lock();						if($this -> module -> dynamic == "Y"){				$this -> items = $this -> module -> get_items();			}		}				/*		 * 如果網址有ID參數，代表根目錄		 **/		else{			$this -> parent_class = $this -> module -> get_single_class(array("id=?"), array($this -> module_io -> id));			if(!$this -> parent_class -> is_exists()){				$this -> module_showbox -> set_message("查無此分類");				$this -> module_go -> back();			}						$this -> is_special_level = (($this -> parent_class -> level + 1) == $this -> module -> class_field_use_level);						if($this -> module -> level <= $this -> parent_class -> level){				$this -> module_go -> page("list_item.php?mod=" . $this -> module_io -> mod . "&id=" . $this -> module_io -> id);			}						$this -> module_pagination -> set_count_per_page($this -> module -> class_count_per_page);			$this -> module_pagination -> unlock();			$this -> item_classes = $this -> parent_class -> get_sub_classes(array(), array(), array("sortTime ASC", "sequence ASC", "createTime DESC"), $this -> is_special_level);			$this -> module_pagination -> lock();						if($this -> module -> dynamic == "Y"){				$this -> items = $this -> parent_class -> get_items();			}		}				if($this -> module -> dynamic == "Y"){			if(count($this -> item_classes) == 0 && count($this -> items) > 0){				if($this -> module_io -> id == ""){					$this -> module_go -> page("list_item.php?mod=" . $this -> module_io -> mod);				}				else{					$this -> module_go -> page("list_item.php?mod=" . $this -> module_io -> mod . "&id=" . $this -> module_io -> id);				}							}		}			}		/**	 * 載入分類清單欄位	 */	private function load_fields(){			if($this -> is_special_level){			$fields = $this -> module -> class_special_fieldMetadata;		}		else{			$fields = $this -> module -> class_fieldMetadata;		} 				foreach($fields as $key => $field){						$special = ($this -> is_special_level) ? "special_" : "";						// 清單預設會顯示發佈時間，如欄位會有發佈時間就不另外顯示			$variable = "class_" . $special . "fieldMetadata_field_variable";			if($field -> {$variable} == "createTime"){				continue;			}						$list = "class_" . $special . "fieldMetadata_field_list";			if($field -> {$list} == "Y"){				$this -> list_fields[] = $field;			}		}	}	/**	 * 新增分類	 */	public function add_class() {		if($this -> module_io -> id == ""){			$this -> module_go -> page("add.php?mod=" . $this -> module_io -> mod);		}		else{			$this -> module_go -> page("add.php?mod=" . $this -> module_io -> mod . "&id=" . $this -> module_io -> id);		}
	}		/**	 * 新增項目	 */	public function add_item() {		if($this -> module_io -> id == ""){			$this -> module_go -> page("add_item.php?mod=" . $this -> module_io -> mod);		}		else{			$this -> module_go -> page("add_item.php?mod=" . $this -> module_io -> mod . "&id=" . $this -> module_io -> id);		}	}	/**	 * 批次刪除	 */	public function delete() {
		if (!is_array($this -> module_io -> ids)) {
			return;
		}
		foreach ($this -> module_io -> ids as $id) {
			$item_class = $this -> module -> get_single_class(array("id=?"),array($id));			if ($item_class -> is_exists()) {				$item_class -> delete();							}		}		$this -> module_showbox -> set_message("刪除成功!");
		$this -> module_go -> back(0);		
	}	/**	 * 批次上架	 */	public function publish() {		if (!is_array($this -> module_io -> ids)) {			return;		}		foreach ($this -> module_io -> ids as $id) {			$item_class = $this -> module -> get_single_class(array("id=?"),array($id));			if ($item_class -> is_exists()) {				$item_class -> publish = "Y";				$item_class -> update();			}		}		$this -> module_showbox -> set_message("批次上架成功!");		$this -> module_go -> back(0);			}		/**	 * 批次下架	 */	public function unpublish() {		if (!is_array($this -> module_io -> ids)) {			return;		}		foreach ($this -> module_io -> ids as $id) {			$item_class = $this -> module -> get_single_class(array("id=?"),array($id));			if ($item_class -> is_exists()) {				$item_class -> publish = "";				$item_class -> update();			}		}		$this -> module_showbox -> set_message("批次下架成功!");		$this -> module_go -> back(0);			}		/**	 * 新增模組	 */	public function sort_class() {		if($this -> module_io -> id == ""){			$this -> module_go -> page("sort.php?mod=" . $this -> module_io -> mod);		}		else{			$this -> module_go -> page("sort.php?mod=" . $this -> module_io -> mod . "&id=" . $this -> module_io -> id);		}	}		/**	 * 上一頁	 */	public function return_level(){		if( $this -> parent_class -> parentId == ""){			$this -> module_go -> page("list.php?mod=" . $this -> module_io -> mod);		}		else{			$this -> module_go -> page("list.php?mod=" . $this -> module_io -> mod . "&id=" . $this -> parent_class -> parentId);		}	}		/**	 * 搜尋	 */	public function search(){		$params = array();		foreach($this -> search_fields as $key => $component){			$value = $this -> module_io -> {$key};						if(!isset($value) || $value == "") continue;			$params[] = $component -> get_variable() . "=" . $value; 		}		if(count($params) > 0){			$this -> module_go -> page("search_item.php?mod=" . $this -> module_io -> mod . "&" . implode("&", $params));		}		else{			$this -> module_showbox -> set_message("請輸入卻搜尋的條件");		}	}}?>