<?php
class Add_Controller extends MasterController {
/**	 * @var 模組資訊	 */	protected $module_metadata = array();	/**	 * @var 模組物件	 */	protected $module = array();

	public function main() {				// 取得模組代碼 並 取得模組元件		$module_code = $this -> module_io -> mod;		// 驗證模組是否存在		if (!isset($this -> master_config["modules"][$module_code])) {			$this -> module_showbox -> set_message("不存在的模組");			$this -> module_go -> back();		}		// 取得模組元資訊		$this -> module_metadata = $this -> master_config["modules"][$module_code];				// 載入元件值		$this -> load_module();	}		/**	 * 載入模組物件資訊	 */	private function load_module() {		$module = $this -> module_dao -> get_object("module");		$module -> extend_field_value($module);		$this -> load_component($module, $this -> module_metadata["fields"]);		$this -> module = $module;	}	/**	 * 載入操作元件	 * @param MDL_Module $module 模組	 * @param Array $fieldMetadatas 欄位資訊	 */	private function load_component(& $module, $fieldMetadatas) {		require_once ($this -> config_full_application_path . "/custom/components/Component.php");		foreach ($fieldMetadatas as $key => $fieldMetadata) {			require_once ($this -> config_full_application_path . "/custom/components/" . $fieldMetadata["type"] . "_Component.php");			$component_name = $fieldMetadata["type"] . "_Component";			$fieldMetadata["variable"] = $key;			$module -> {$fieldMetadata["variable"]} = new $component_name($module -> {$fieldMetadata["variable"]} , $fieldMetadata, $module);		}			}	/**	 * 儲存	 */	public function save() {		// 欄位驗證是否過關		$valid_success = true;				// 開始儲值輸入值至元件		foreach($this -> module_metadata["fields"] as $key => $fieldMetadata){			$field = $this -> module -> {$key};			$value = $this -> module_io -> {$key};			// 把輸入值設定至元件			$field -> set_value( $value );						// 到目前為止是否所有欄位都驗證成功？			$valid_success = $valid_success & ( $field -> get_valid_error_message() == "" );		}						// 驗證成功 (儲存)		if($valid_success){						$this -> module -> moduleType = $this -> module_metadata["type"];			$this -> module -> createTime = date("Y-m-d H:i:s");			$this -> module -> insert(false, true);			$this -> module_showbox -> set_message("新增成功!");									// 動態增減欄位			if(!in_array($this -> module -> moduleType,array("Note","Permission"))){				$this -> module_loader -> load("dynamic_db_field");				$this -> module_dynamic_db_field -> set_db_name($this -> module -> code -> get_value());				$this -> module_dynamic_db_field -> alter_table($this -> module, array("fieldMetadata"));									$this -> module_dynamic_db_field -> set_db_name($this -> module -> code -> get_value(), true);				$this -> module_dynamic_db_field -> alter_table($this -> module, array("class_fieldMetadata","class_special_fieldMetadata"));			}									$this -> module_go -> back();		}	}	public function alter_table(){		$db_name = $this -> module -> code -> get_value();		$this -> module_db -> set_command($sql);		$sql = "DESCRIBE <prefix>{$db_name};";		$res = $this -> module_db -> execute_query();		$fields = array();		foreach ($res as $field) {			$fields[$field["Field"]] = true;		}	}
}
?>